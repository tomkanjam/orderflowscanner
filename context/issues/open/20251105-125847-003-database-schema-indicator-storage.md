# Database Schema for Indicator Storage

**Type:** feature
**Initiative:** End-to-end trader workflow implementation
**Created:** 2025-01-05 12:58:47

## Context

Need to store series code in traders table and indicator data in signals table to enable custom indicator visualization on charts.

## Linked Items

- Part of: `context/issues/open/20251105-125847-001-PROJECT-custom-indicator-visualization.md`

## Progress

✅ **Completed** (2025-01-05)

- Created migration file: 034_add_indicator_data_to_signals.sql
- Applied to production database (jtpqkbybuxbcvqeffmtf)
- Column added: signals.indicator_data JSONB (nullable)
- Index created: idx_signals_indicator_data (GIN)
- Column comment added for documentation
- Schema verified via SQL query

## Spec

### Required Schema Changes

#### 1. Traders Table

Currently stores filter code in `filter` JSONB column. The structure will remain JSONB but include the new seriesCode field.

No schema change needed - the existing `filter` JSONB column will accommodate the new structure:

```json
{
  "code": "// filter code",
  "seriesCode": "// NEW: series code",
  "description": ["conditions"],
  "indicators": [/* NEW: indicator configs */],
  "requiredTimeframes": ["5m"]
}
```

#### 2. Signals Table

Add JSONB column for storing calculated indicator data:

```sql
ALTER TABLE signals ADD COLUMN indicator_data JSONB;
CREATE INDEX idx_signals_indicator_data ON signals USING gin(indicator_data);
```

**Data structure:**
```json
{
  "rsi_14": [
    {"x": 1704470400000, "y": 45.2},
    {"x": 1704470700000, "y": 48.7}
  ],
  "stoch_rsi_k": [
    {"x": 1704470400000, "y": 35.4},
    {"x": 1704470700000, "y": 42.1}
  ]
}
```

### Index Strategy

**GIN Index on indicator_data:**
- Enables efficient JSONB queries
- Allows filtering by indicator presence
- Future: Query signals by indicator values

Example queries enabled:
```sql
-- Find signals with specific indicator
SELECT * FROM signals WHERE indicator_data ? 'rsi_14';

-- Find signals where RSI was below 30
SELECT * FROM signals
WHERE (indicator_data->'rsi_14'->-1->>'y')::float < 30;
```

### Storage Analysis

**Per-signal storage:**
- 1 indicator (150 points): ~1.5KB
- 3 indicators (150 points each): ~5KB
- 5 indicators (150 points each): ~8KB

**Scale estimates:**
- 1,000 signals × 5KB = 5MB
- 10,000 signals × 5KB = 50MB
- 100,000 signals × 5KB = 500MB

**Negligible for modern databases.** Supabase free tier: 500MB included.

### Migration File

Create: `supabase/migrations/XXX_add_indicator_data_to_signals.sql`

```sql
-- Add indicator_data column to signals table
-- This stores calculated indicator values for chart visualization
ALTER TABLE signals ADD COLUMN indicator_data JSONB;

-- Create GIN index for efficient JSONB queries
CREATE INDEX idx_signals_indicator_data ON signals USING gin(indicator_data);

-- Add comment for documentation
COMMENT ON COLUMN signals.indicator_data IS
'Calculated indicator values for chart visualization.
Format: {"indicator_id": [{"x": timestamp, "y": value, "y2"?: value, ...}]}
Generated by series code execution when signal is created.';
```

### Validation

After migration:

```sql
-- Verify column exists
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'signals' AND column_name = 'indicator_data';

-- Verify index exists
SELECT indexname, indexdef
FROM pg_indexes
WHERE tablename = 'signals' AND indexname = 'idx_signals_indicator_data';

-- Test insert
INSERT INTO signals (id, trader_id, symbol, indicator_data)
VALUES (gen_random_uuid(), 'test-trader', 'BTCUSDT',
  '{"rsi_14": [{"x": 1704470400000, "y": 45.2}]}'::jsonb
);

-- Verify GIN index works
EXPLAIN ANALYZE
SELECT * FROM signals WHERE indicator_data ? 'rsi_14';
-- Should show "Index Scan using idx_signals_indicator_data"
```

### Rollback Plan

If needed to revert:

```sql
-- Remove index
DROP INDEX IF EXISTS idx_signals_indicator_data;

-- Remove column
ALTER TABLE signals DROP COLUMN IF EXISTS indicator_data;
```

### Data Migration

No data migration needed since this is a new column. Existing signals will have `NULL` indicator_data, which is acceptable (they were created before this feature).

## Implementation Steps

1. Create migration file
2. Test on local Supabase (if available) or dev environment
3. Apply to production Supabase
4. Verify column and index created
5. Test insert/query performance
6. Update Go types to include IndicatorData field

## Completion Criteria

1. ✅ Migration file created
2. ✅ Applied to production database
3. ✅ Column exists: `signals.indicator_data JSONB`
4. ✅ Index exists: `idx_signals_indicator_data`
5. ✅ Test insert works
6. ✅ GIN index performs efficiently
