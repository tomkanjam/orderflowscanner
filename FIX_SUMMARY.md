# Fix Summary: Chart Crash Prevention

## Issue
App went black when clicking signals for newly created traders due to `TypeError: Cannot read properties of undefined (reading 'color')` in `chartHelpers.ts:39`.

## Root Cause
**Schema Mismatch:** LLM-generated indicators were missing required fields that the frontend TypeScript interface expects.

### Generated by LLM (Incorrect)
```json
{
  "id": "stoch_rsi_k",
  "name": "StochRSI %K",
  "type": "line",           // ← Wrong field name
  "panel": true,
  "params": {...}
  // Missing: style, calculateFunction, chartType
}
```

### Expected by Frontend
```typescript
interface CustomIndicatorConfig {
  id: string;
  name: string;
  chartType: 'line' | 'bar';   // ← Not 'type'
  panel: boolean;
  calculateFunction: string;    // ← Required
  style: {                      // ← Required (was undefined)
    color?: string | string[];
    lineWidth?: number;
    barColors?: {...};
  };
  params: any;
}
```

## Solution Applied

### 1. Updated Prompt Template ✅
**File:** `backend/go-screener/prompts/regenerate-filter-go.md`

- Changed field name: `type` → `chartType`
- Added required `style` object with default colors
- Added `calculateFunction: ""` (empty for Go backend)
- Added color palette guidance
- Added MACD histogram example with barColors
- Emphasized "CRITICAL" requirement

**Example output now:**
```json
{
  "id": "rsi_14",
  "name": "RSI (14)",
  "chartType": "line",
  "panel": true,
  "calculateFunction": "",
  "style": {
    "color": "#8efbba",
    "lineWidth": 1.5
  },
  "params": {"period": 14}
}
```

### 2. Added Defensive Null-Safety ✅
**File:** `apps/app/utils/chartHelpers.ts`

Both `createEmptyDatasets()` and `createIndicatorDatasets()` now:
```typescript
// Ensure style exists with defaults
const style = indicator.style || { color: '#8efbba', lineWidth: 1.5 };
```

This prevents crashes even if:
- Legacy indicators exist in database
- Future prompt changes introduce errors
- Manual trader creation has bugs

### 3. Uploaded to Braintrust ✅
- New version: `1000196117993264267`
- 599 lines (was 552 lines)
- Verified placeholders intact

## Commit
```
1f09142 - fix: prevent chart crash from malformed indicator schema
```

## Testing Instructions

### Step 1: Delete Broken Trader
```sql
DELETE FROM traders WHERE id = '47a3621f-3dbd-4328-8fe2-0b56d3cbc870';
```

Or via UI: Delete "1m Stoch RSI Low" trader

### Step 2: Wait for Cache Clear
Edge Function has 5-minute cache. Either:
- **Wait:** 5 minutes from upload (14:36 UTC)
- **Restart:** Edge Function container to clear immediately

### Step 3: Create New Trader
1. Open TraderForm
2. Enter description: "Entry: When the 1-minute Stochastic RSI K line crosses below 40"
3. Generate strategy
4. Verify generated code includes:
   - `filterCode` with StochRSI logic
   - `seriesCode` returning indicator data
   - `indicators` array with proper schema

Expected `indicators`:
```json
[
  {
    "id": "stoch_rsi_k",
    "name": "StochRSI %K",
    "chartType": "line",
    "panel": true,
    "calculateFunction": "",
    "style": {
      "color": "#8efbba",
      "lineWidth": 1.5
    },
    "params": {...}
  }
]
```

### Step 4: Test Chart Display
1. Wait for signals to generate
2. Click on a signal row
3. **Verify:**
   - ✅ App does NOT go black
   - ✅ Candlestick chart appears
   - ✅ StochRSI indicator panel appears below
   - ✅ K and D lines render correctly

### Step 5: Verify Legacy Trader Compatibility
The broken trader with old schema should now work (won't crash):
1. Check signals table for trader `47a3621f-3dbd-4328-8fe2-0b56d3cbc870`
2. Click a signal
3. Should see chart with default mint green color (fallback)

## Files Changed

| File | Changes | Impact |
|------|---------|--------|
| `backend/go-screener/prompts/regenerate-filter-go.md` | +57 lines | LLM generates correct schema |
| `apps/app/utils/chartHelpers.ts` | +10 lines | Graceful fallback for bad data |

## Prevention

This fix implements **defense in depth**:

1. **Source Fix:** Prompt generates correct schema
2. **Runtime Safety:** Code handles malformed data gracefully
3. **Clear Documentation:** Examples show exact required format
4. **Type Safety:** TypeScript interface enforces contract

Future schema changes should:
- Update prompt examples first
- Update TypeScript interface
- Add migration for existing data if needed
- Test with both new and legacy data

## Related Issues
- Original: Missing variable placeholders (commit `28fb761`)
- This fix: Schema mismatch causing crashes (commit `1f09142`)

Both issues stemmed from incomplete prompt template specification.
