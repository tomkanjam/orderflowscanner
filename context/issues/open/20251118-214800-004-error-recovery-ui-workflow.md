# Error Recovery UI Workflow

**Type:** feature
**Initiative:** End-to-end trader workflow implementation
**Created:** 2025-11-18 21:48:00

## Context

After automatic filter code regeneration (issue 003), users need a UI to:
- View the error details
- Review the proposed fix code
- See a diff of changes
- Test the fix before deployment
- Accept or reject the fix
- Manually edit if needed

This completes the end-to-end error recovery workflow.

## Linked Items

- Part of: `context/issues/open/20251118-214800-000-PROJECT-trader-error-recovery-system.md`
- Depends on: `context/issues/open/20251118-214800-003-automatic-filter-code-regeneration.md`

## Progress

Not started.

## Spec

### Page Structure

**Route**: `/traders/:traderId/errors/:errorId`

**Layout**:
```
┌─────────────────────────────────────────────────┐
│ [← Back to Trader]  Trader Error Recovery      │
├─────────────────────────────────────────────────┤
│                                                 │
│  Error Details Card                            │
│  • Type: runtime                               │
│  • Occurred: 5 minutes ago                     │
│  • Message: nil pointer dereference            │
│  • Stack trace [expand]                        │
│                                                 │
│ ┌─────────────────┬─────────────────────────┐ │
│ │  Original Code   │  Proposed Fix          │ │
│ │ (failed)         │  (generated by AI)     │ │
│ ├─────────────────┼─────────────────────────┤ │
│ │                 │                         │ │
│ │ [Code Editor]   │  [Code Editor]         │ │
│ │                 │                         │ │
│ │                 │                         │ │
│ │                 │  [✓] Validated         │ │
│ │                 │  [⚠] Not validated     │ │
│ └─────────────────┴─────────────────────────┘ │
│                                                 │
│  Diff View Toggle: [Unified] [Split]          │
│                                                 │
│  [Test Fix] [Accept & Deploy] [Edit Manually] │
│                                                 │
└─────────────────────────────────────────────────┘
```

### Components

**1. ErrorDetailsCard** (`src/components/trader/ErrorDetailsCard.tsx`)

```typescript
interface ErrorDetailsCardProps {
  error: TraderExecutionError
  trader: Trader
}

export function ErrorDetailsCard({ error, trader }: ErrorDetailsCardProps) {
  const [showStackTrace, setShowStackTrace] = useState(false)

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center gap-2">
          <AlertTriangle className="h-5 w-5 text-destructive" />
          {error.error_type} Error
        </CardTitle>
        <CardDescription>
          Occurred {formatDistanceToNow(new Date(error.created_at))} ago
        </CardDescription>
      </CardHeader>
      <CardContent className="space-y-4">
        {/* Error message */}
        <div>
          <Label>Error Message</Label>
          <div className="mt-1 p-3 bg-destructive/10 rounded-md font-mono text-sm">
            {error.error_message}
          </div>
        </div>

        {/* Execution context */}
        <div className="grid grid-cols-3 gap-4 text-sm">
          <div>
            <Label>Trigger Interval</Label>
            <div>{error.trigger_interval}</div>
          </div>
          <div>
            <Label>Symbols Processed</Label>
            <div>{error.symbols_processed}</div>
          </div>
          <div>
            <Label>Execution Duration</Label>
            <div>{error.execution_duration_ms}ms</div>
          </div>
        </div>

        {/* Stack trace (collapsible) */}
        <div>
          <Button
            variant="ghost"
            size="sm"
            onClick={() => setShowStackTrace(!showStackTrace)}
          >
            {showStackTrace ? 'Hide' : 'Show'} Stack Trace
          </Button>
          {showStackTrace && (
            <pre className="mt-2 p-3 bg-muted rounded-md text-xs overflow-x-auto">
              {error.stack_trace}
            </pre>
          )}
        </div>

        {/* Regeneration status */}
        {error.proposed_fix_code && (
          <div className="flex items-center gap-2 text-sm">
            <Sparkles className="h-4 w-4 text-primary" />
            <span>AI fix generated {formatDistanceToNow(new Date(error.regenerated_at))} ago</span>
            {error.proposed_fix_validated ? (
              <Badge variant="success">✓ Validated</Badge>
            ) : (
              <Badge variant="warning">⚠ Not validated</Badge>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  )
}
```

**2. CodeDiffViewer** (`src/components/trader/CodeDiffViewer.tsx`)

```typescript
import { DiffEditor } from '@monaco-editor/react'

interface CodeDiffViewerProps {
  originalCode: string
  proposedCode: string
  language?: string
}

export function CodeDiffViewer({ originalCode, proposedCode, language = 'go' }: CodeDiffViewerProps) {
  return (
    <div className="border rounded-lg overflow-hidden">
      <DiffEditor
        height="500px"
        language={language}
        original={originalCode}
        modified={proposedCode}
        theme="vs-dark"
        options={{
          readOnly: true,
          renderSideBySide: true,
          minimap: { enabled: false }
        }}
      />
    </div>
  )
}
```

**3. ErrorRecoveryActions** (`src/components/trader/ErrorRecoveryActions.tsx`)

```typescript
interface ErrorRecoveryActionsProps {
  error: TraderExecutionError
  trader: Trader
  onAccept: () => Promise<void>
  onTest: () => Promise<void>
  onEdit: () => void
}

export function ErrorRecoveryActions({
  error,
  trader,
  onAccept,
  onTest,
  onEdit
}: ErrorRecoveryActionsProps) {
  const [testing, setTesting] = useState(false)
  const [accepting, setAccepting] = useState(false)

  const handleTest = async () => {
    setTesting(true)
    try {
      await onTest()
      toast.success('Code tested successfully!')
    } catch (err) {
      toast.error(`Test failed: ${err.message}`)
    } finally {
      setTesting(false)
    }
  }

  const handleAccept = async () => {
    const confirmed = await confirm({
      title: 'Deploy Fixed Code?',
      description: 'This will update the filter code on your dedicated Fly machine.',
      confirmText: 'Deploy'
    })

    if (!confirmed) return

    setAccepting(true)
    try {
      await onAccept()
      toast.success('Code deployed successfully!')
      router.push(`/traders/${trader.id}`)
    } catch (err) {
      toast.error(`Deployment failed: ${err.message}`)
    } finally {
      setAccepting(false)
    }
  }

  return (
    <div className="flex gap-3">
      <Button
        variant="outline"
        onClick={handleTest}
        disabled={testing || !error.proposed_fix_code}
        loading={testing}
      >
        <TestTube className="mr-2 h-4 w-4" />
        Test Fix
      </Button>

      <Button
        variant="default"
        onClick={handleAccept}
        disabled={accepting || !error.proposed_fix_validated}
        loading={accepting}
      >
        <Check className="mr-2 h-4 w-4" />
        Accept & Deploy
      </Button>

      <Button
        variant="ghost"
        onClick={onEdit}
      >
        <Edit className="mr-2 h-4 w-4" />
        Edit Manually
      </Button>
    </div>
  )
}
```

**4. ErrorRecoveryPage** (`src/app/traders/[traderId]/errors/[errorId]/page.tsx`)

```typescript
'use client'

import { useParams } from 'next/navigation'
import { useQuery, useMutation } from '@tanstack/react-query'

export default function ErrorRecoveryPage() {
  const { traderId, errorId } = useParams()

  // Fetch error details
  const { data: error, isLoading } = useQuery({
    queryKey: ['trader-error', errorId],
    queryFn: () => fetchTraderError(errorId)
  })

  // Fetch trader details
  const { data: trader } = useQuery({
    queryKey: ['trader', traderId],
    queryFn: () => fetchTrader(traderId)
  })

  // Test proposed fix mutation
  const testMutation = useMutation({
    mutationFn: async () => {
      const response = await fetch(`/api/traders/${traderId}/test-filter`, {
        method: 'POST',
        body: JSON.stringify({
          filter_code: error.proposed_fix_code
        })
      })
      if (!response.ok) throw new Error(await response.text())
      return response.json()
    }
  })

  // Accept fix mutation
  const acceptMutation = useMutation({
    mutationFn: async () => {
      // 1. Update trader in database
      await supabase
        .from('traders')
        .update({
          filter: {
            ...trader.filter,
            code: error.proposed_fix_code
          }
        })
        .eq('id', traderId)

      // 2. Mark error as resolved
      await supabase
        .from('trader_execution_errors')
        .update({
          resolved_at: new Date().toISOString(),
          fix_applied_at: new Date().toISOString(),
          fix_applied_by: user.id
        })
        .eq('id', errorId)

      // 3. Reload trader on Fly machine
      await fetch(`/api/traders/${traderId}/reload`, {
        method: 'POST'
      })
    },
    onSuccess: () => {
      queryClient.invalidateQueries(['trader', traderId])
      router.push(`/traders/${traderId}`)
    }
  })

  if (isLoading) return <LoadingSpinner />
  if (!error || !trader) return <NotFound />

  return (
    <div className="container max-w-6xl py-8 space-y-6">
      {/* Header */}
      <div>
        <Button variant="ghost" asChild>
          <Link href={`/traders/${traderId}`}>
            <ArrowLeft className="mr-2 h-4 w-4" />
            Back to Trader
          </Link>
        </Button>
        <h1 className="text-3xl font-bold mt-4">Error Recovery</h1>
        <p className="text-muted-foreground">{trader.name}</p>
      </div>

      {/* Error details */}
      <ErrorDetailsCard error={error} trader={trader} />

      {/* Code comparison */}
      {error.proposed_fix_code ? (
        <Card>
          <CardHeader>
            <CardTitle>Code Changes</CardTitle>
          </CardHeader>
          <CardContent>
            <CodeDiffViewer
              originalCode={error.filter_code_snapshot}
              proposedCode={error.proposed_fix_code}
            />
          </CardContent>
        </Card>
      ) : (
        <Card>
          <CardContent className="py-8 text-center text-muted-foreground">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-2" />
            <p>Generating fix...</p>
          </CardContent>
        </Card>
      )}

      {/* Actions */}
      <ErrorRecoveryActions
        error={error}
        trader={trader}
        onTest={() => testMutation.mutateAsync()}
        onAccept={() => acceptMutation.mutateAsync()}
        onEdit={() => router.push(`/traders/${traderId}/edit`)}
      />
    </div>
  )
}
```

### Testing Flow

**Test Endpoint** (`POST /api/traders/:traderId/test-filter`):

```typescript
// Validate + execute filter on sample data without persisting
export async function POST(req: Request, { params }: { params: { traderId: string } }) {
  const { filter_code } = await req.json()

  // 1. Validate code
  const validation = await validateGoCode(filter_code)
  if (!validation.valid) {
    return Response.json({ error: validation.error }, { status: 400 })
  }

  // 2. Execute on sample data (10 symbols, 1 timeframe)
  const result = await executeFilterTest({
    trader_id: params.traderId,
    filter_code,
    symbols: ['BTCUSDT', 'ETHUSDT', 'BNBUSDT'], // Sample
    timeframes: ['5m']
  })

  return Response.json({
    success: true,
    matched_symbols: result.matches,
    execution_time_ms: result.duration
  })
}
```

### Mobile-Responsive Design

- Stack code editors vertically on mobile
- Use monaco-editor mobile mode
- Swipe between original/proposed on mobile
- Fixed action buttons at bottom

### Acceptance Criteria

- ✅ Error details displayed with full context
- ✅ Side-by-side code diff (desktop) or stacked (mobile)
- ✅ Test button validates + executes on sample data
- ✅ Accept button deploys to Fly machine
- ✅ Manual edit redirects to trader edit page
- ✅ Resolved errors marked in database
- ✅ Full mobile responsiveness
- ✅ Toast notifications for all actions
