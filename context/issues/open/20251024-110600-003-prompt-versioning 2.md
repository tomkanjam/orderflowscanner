# Implement Prompt Version Tracking

**Type:** feature
**Initiative:** End-to-end trader workflow implementation
**Created:** 2025-10-24 11:06:03

## Context

Currently, `PromptLoaderV2` loads prompts from Braintrust by slug only, with no version control. This means:
- Can't A/B test different prompt versions
- Can't rollback to previous versions if quality regresses
- Can't track which version produced which results
- Can't run experiments comparing prompt variations

**Current State:**
- `PromptLoaderV2.ts` loads by slug: `loadPrompt(slug: string)`
- Operations config has no `promptVersion` field
- Braintrust supports versioning but we're not using it
- No way to pin operations to specific prompt versions

**Impact:**
Cannot systematically improve prompts or measure impact of changes.

## Linked Items
- Part of: `context/issues/open/20251024-110600-000-PROJECT-complete-braintrust-integration.md`

## Progress

Issue created, awaiting implementation.

## Spec

**Implementation Steps:**

1. **Update PromptLoaderV2 to support versions**
   - Modify `/supabase/functions/llm-proxy/promptLoader.v2.ts`
   - Change signature: `loadPrompt(slug: string, version?: string)`
   - If version provided: fetch specific version from Braintrust
   - If no version: fetch latest (current behavior)
   - Update REST API call to include version parameter

2. **Add version field to operations config**
   - Update `/supabase/functions/llm-proxy/config/operations.ts`
   - Add `promptVersion` field to each operation
   ```typescript
   'generate-filter-code': {
     modelId: 'anthropic/claude-haiku-4.5',
     temperature: 0.2,
     maxTokens: 4096,
     promptSlug: 'regenerate-filter-go',
     promptVersion: 'v1.0.0'  // <-- Add this
   }
   ```

3. **Update operation handlers to pass version**
   - Modify all operation handlers to pass version to PromptLoaderV2
   - Examples: `generateFilterCode.ts`, `generateTrader.ts`, etc.
   ```typescript
   const prompt = await promptLoader.loadPrompt(
     operationConfig.promptSlug,
     operationConfig.promptVersion
   );
   ```

4. **Log version in Braintrust traces**
   - Update OpenRouter traced calls to include prompt version in metadata
   - Tag: `prompt_version: "v1.0.0"`
   - Enables filtering traces by prompt version in dashboard

5. **Create version management workflow**
   - Update `/scripts/upload-prompt-to-braintrust.ts` to support versioning
   - Add version parameter: `--version v1.0.0`
   - Document versioning strategy (semantic versioning)

6. **Create version comparison utility**
   - Script to compare outputs from different prompt versions
   - Uses Braintrust experiments API
   - Outputs side-by-side comparison

**Files to Modify:**
- `/supabase/functions/llm-proxy/promptLoader.v2.ts` - Add version support
- `/supabase/functions/llm-proxy/config/operations.ts` - Add version fields
- All operation handlers - Pass version to loader
- `/supabase/functions/llm-proxy/openRouterClient.ts` - Log version in traces
- `/scripts/upload-prompt-to-braintrust.ts` - Support versioning

**Documentation:**
Create `/context/docs/PROMPT_VERSIONING.md` with:
- Versioning strategy (semantic versioning guidelines)
- How to create new prompt version
- How to roll back to previous version
- How to A/B test versions
- How to view version performance in Braintrust

**Testing:**
- Upload same prompt with two different versions
- Configure operation to use v1, verify it loads correct version
- Change to v2, verify it loads new version
- Confirm version appears in Braintrust traces
- Test with missing version (should fail gracefully)

**Success Criteria:**
- All operations specify prompt version in config
- PromptLoaderV2 loads correct version
- Version logged in every Braintrust trace
- Can A/B test different versions by changing config
- Documentation explains versioning workflow
