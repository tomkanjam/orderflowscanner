# Fly.io Configuration for AI-Powered Crypto Screener Machine
# Documentation: https://fly.io/docs/reference/configuration/

app = "vyx-app"
primary_region = "sjc" # San Jose - US West Coast (will be overridden per machine)

# Build configuration
[build]
  dockerfile = "Dockerfile.prod"

# Environment variables (non-sensitive)
[env]
  NODE_ENV = "production"
  KLINE_INTERVAL = "5m"
  SCREENING_INTERVAL_MS = "60000"

# HTTP service configuration
[[services]]
  internal_port = 8080
  protocol = "tcp"
  auto_stop_machines = false
  auto_start_machines = true
  min_machines_running = 0

  # WebSocket support
  [[services.ports]]
    handlers = ["http"]
    port = 80
    force_https = true

  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

  # Health checks
  [[services.tcp_checks]]
    grace_period = "30s"
    interval = "15s"
    timeout = "10s"
    restart_limit = 3

  [[services.http_checks]]
    interval = "30s"
    grace_period = "30s"
    method = "GET"
    path = "/health"
    protocol = "http"
    timeout = "10s"
    tls_skip_verify = false

# VM resources - dynamically scaled by DynamicScaler
[compute]
  size = "shared-cpu-1x" # 1 vCPU, 256MB RAM (base configuration)
  # Can be dynamically adjusted to:
  # shared-cpu-2x (2 vCPU, 512MB)
  # shared-cpu-4x (4 vCPU, 1GB)
  # shared-cpu-8x (8 vCPU, 2GB)

# Metrics and monitoring
[metrics]
  port = 9091
  path = "/metrics"

# Deployment configuration
[deploy]
  strategy = "immediate"
  max_unavailable = 0

# Secrets (set via: flyctl secrets set KEY=VALUE)
# Required secrets:
# - USER_ID
# - MACHINE_ID
# - SUPABASE_URL
# - SUPABASE_SERVICE_KEY
# - MACHINE_REGION (optional, defaults to primary_region)
